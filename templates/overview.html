<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=no"
    />
    <link rel="shortcut icon" href="/templates/static/favicon.ico">
    <title>Auto Bot</title>
    <style type="text/css">
        body {
          -webkit-font-smoothing: antialiased;
          -moz-font-smoothing: grayscale;
        }

        #sidebar {
          position: fixed;
          height: 100vh;
          background-color: #f5f5f5;
          padding-top: 68px;
          padding-left: 0;
          padding-right: 0;
        }

        #sidebar .ui.menu > a.item {
          padding: 10px 20px;
          line-height: 20px;
          color: #123123;
          border-radius: 0 !important;
          margin-top: 0;
          margin-bottom: 0;
        }

        #sidebar .ui.menu > a.item.active {
          background-color: #123123;
          color: white;
          border: none !important;
        }

        #sidebar .ui.menu > a.item:hover {
          background-color: #eee;
          color: #23527c;
        }

        #content {
          padding-top: 56px;
          padding-left: 20px;
          padding-right: 20px;
        }

        #content h1 {
          font-size: 36px;
        }

        #content .ui.dividing.header {
          width: 100%;
        }

        .ui.centered.small.circular.image {
          margin-top: 14px;
          margin-bottom: 14px;
        }

        .ui.borderless.menu {
          box-shadow: none;
          flex-wrap: wrap;
          border: none;
          padding-left: 0;
          padding-right: 0;
        }

        .ui.mobile.only.grid .ui.menu .ui.vertical.menu {
          display: none;
        }

      </style>

      <!-- You MUST include jQuery before Fomantic -->
      <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
      <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.js"></script>

  </head>
  <body id="root">
      <div class="ui tablet computer only padded grid">
        <div class="ui inverted borderless top fixed fluid menu">
          <a href="/overview" class="header item"><i class="inverted big olive robot icon"></i>Auto Bot</a>
          <div class="right menu">
            <a style="pointer-events: none; cursor: default;" class="item">
              <img class="ui right spaced avatar image" src="/templates/static/ms.jpg">
              M. Soydan
            </a>
            <a href="/login" class="item">Sign out</a>
          </div>
        </div>
      </div>

      <!---THIS SECTION IS MOBILE ONLY BEGIN---->
      <div class="ui mobile only padded grid">
        <div class="ui top fixed borderless fluid inverted menu">
          <a href="/overview" class="header item"><i class="inverted big olive robot icon"></i>Auto Bot</a>
          <div class="right menu">
            <div class="item">
              <button class="ui icon toggle basic inverted button">
                <i class="content icon"></i>
              </button>
            </div>
          </div>
          <div class="ui vertical borderless inverted fluid menu">
            <a style="pointer-events: none; cursor: default;" class="item">
              <img class="ui right spaced avatar image" src="/templates/static/ms.jpg">
              M. Soydan
            </a>
            <a href="/login" class="item">Sign out</a>
            <div class="ui fitted divider"></div>
          </div>
        </div>
      </div>
      <!---THIS SECTION IS MOBILE ONLY END---->

      <div class="ui padded grid">
        <div
          class="two wide tablet only two wide computer only column"
          id="sidebar"
        >
          <div class="ui massive vertical borderless fluid text menu">
            <a href="/overview" class="active item">Overview <em data-emoji=":clipboard:" class="small"></em></a>
            <a href="/create_task" class="item">Create Task <em data-emoji=":crayon:" class="small"></em></a>
            <a href="/task_reports" class="item">Task Reports <em data-emoji=":bar_chart:" class="small"></em></a>
            <a href="/database" class="item">Database <em data-emoji=":card_box:" class="small"></em></a>
            <a href="/bot_settings" class="item">Bot Settings <em data-emoji=":tools:" class="small"></em></a>
          </div>
        </div>
        <div
          class="sixteen wide mobile fourteen wide tablet fourteen wide computer right floated column"
          id="content"
        >
          <div class="ui center aligned padded grid">
            <div class="row">
              <h1 class="ui huge dividing header">Statistics</h1><br> <br>
            </div>
            <div class="center aligned row">
              <div
                class="eight wide mobile four wide tablet four wide computer column"
              >
              <div class="ui red raised  segment">
              <div class="ui statistic">

                <div id="statistics_email" class="value">
                  {{ num_emails }}
                </div>
                <div class="label">
                  <i class="red envelope outline icon"></i> Emails
                </div>
                </div>
                </div>
              </div>
              <div
                class="eight wide mobile four wide tablet four wide computer column"
              >
              <div class="ui purple raised  segment">
              <div class="ui statistic">
                <div class="value">
                  0
                </div>
                <div class="label">
                  <i class="purple instagram icon"></i> Instagram Accounts
                </div>
                </div>
                </div>
              </div>
              <div
                class="eight wide mobile four wide tablet four wide computer column"
              >
              <div class="ui blue raised  segment">
              <div class="ui statistic">
                <div class="value">
                  {{ num_tasks }}
                </div>
                <div class="label">
                  <i class="blue tasks icon"></i> COMPLETED TASKS
                </div>
                </div>
                </div>
              </div>
              <div
                class="eight wide mobile four wide tablet four wide computer column"
              >
              <div class="ui olive raised  segment">
              <div class="ui statistic">
                <div class="value">
                  {{ num_bots }}
                </div>
                <div class="label">
                  <i class="olive robot icon"></i> ACTIVE BOTS
                </div>
                </div>
                </div>
              </div>
            </div>
            <div class="ui hidden section divider"></div>
            <div class="row">
              <h1 class="ui huge dividing header">Active Tasks</h1>
            </div>
            <div class="row">
              {%for task in tasks%}
              <div class="ui segment">
                <div class="ui center aligned very relaxed grid" >
                  <div class="column">

                      <div class="item">
                        <a class="active title">
                          <div class="ui  left aligned segment">
                      <i class="tasks icon"></i>
                        Task {{ task.id }}
                      <button class="ui tiny right floated icon button" onclick="stopTask()" style="margin-top: -5px;" ><i class="red power off icon"></i></button>

                    </div>


                </a>
                        <div class="active content">
                    <div class="ui form">
                      <div class="grouped fields">

                        {%for bot in task.bots_array%}

                        <div class="field">
                          <div>
                            <i class="olive robot icon"></i> <label>Bot {{ bot }}</label>
                            <div class="ui indicating progress" id="bot{{ bot }}">
                                <div class="bar"></div>
                                </div>
                          </div>
                        </div>

                        {%endfor%}






                          <p> {{ task.target }} - Target <i class="flag checkered icon"></i></p>
                      </div>
                    </div>
                        </div>
                      </div>
                  </div>

                </div><br>
                <div class="ui center aligned grid">
                  <p id="task{{ task.id }}a"> {{ task.attempts }} - Attempts <i class="blue sync alternate icon"></i></p>
                  <p id="task{{ task.id }}s"> {{ task.success }} - Success <i class="green check icon"></i></p>
                  <div class="ui tiny blue active primary inline loader"></div>

                </div>
              </div>
              {%endfor%}

            </div>
          </div>
        </div>
      </div>

      <!--HIDDEN DIV AND CLICK HANDLES FOR JS BEGIN-->

      <div class="ui tiny modal">
  <div class="header">Are you sure to stop the active task?</div>
  <div class="content">
    When you click "Approve" all the subtasks that bots are occupied with will be terminated.
  </div>
  <div class="actions">
    <div class="ui olive approve button">Approve</div>
    <div class="ui red cancel button">Cancel</div>
  </div>
</div>
      <script>
        $(document).ready(function() {
          $(".ui.toggle.button").click(function() {
            $(".mobile.only.grid .ui.vertical.menu").toggle(100);
          });
        });

      </script>
      <script>
      $(document).ready(function()  {
        $('.ui.approve.button').click(function(){
          $('body')
            .toast({
              title: 'Task Stopped!',
              message: 'The task will be terminating shortly',
              showProgress: 'bottom',
              classProgress: 'red'
            })
            ;
        });
      });
      </script>
      <script>
      $(document).ready(function()  {
        $('.ui.icon.button').click(function(){
          $('.ui.modal').modal({detachable:false}).modal('show');
        });
      });

      </script>
      <script>
      var bot_ids = {{ bot_ids }}
      var bot_ips = {{ bot_ips|tojson }}
      var task_ids = {{ task_ids }}
      var task_amount = task_ids.length
      var bot_amount = bot_ids.length
      var stats = []
      var attempts = []
      var successes = []
      var email = 0
      var max = 0
      var max2 = 0
      for (let x = 0; x < bot_amount; x++){
        if (max <= bot_ids[x]){
          max = bot_ids[x]
        }
      }
      for (let x = 0; x < task_amount; x++){
        if (max2 <= task_ids[x]){
          max2 = task_ids[x]
        }
      }
      for (let x = 1; x < max+1; x++){
        stats[x] = "0"
      }
      for (let x = 1; x < max2+1; x++){
        attempts[x] = "0"
      }
      for (let x = 1; x < max2+1; x++){
        successes[x] = "0"
      }

      function updateBarsInner(bot_id, bot_ip){
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;

        xhr.addEventListener("readystatechange", function() {
          if(this.readyState === 4) {
            stats[bot_id] = this.responseText.trim()
          }
        });

        xhr.open("GET", "http://"+bot_ip+"/get_status");

        xhr.send();


       var bot_name = "#bot"
        bot_name = bot_name.concat(String(bot_id))
        if(stats[bot_id] == "0"){
          console.log(0)
          $(bot_name).progress({percent: 0});
        }
        else if(stats[bot_id] == "1"){
          console.log(1)
          $(bot_name).progress({percent: 22});
        }
        else if(stats[bot_id] == "2"){
          console.log(2)
          $(bot_name).progress({percent: 66});
        }
        else if(stats[bot_id] == "3"){
          console.log(3)
          $(bot_name).progress({percent: 100});
        }

      }

      function updateAttemptsInner(task_id){
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;

        xhr.addEventListener("readystatechange", function() {
          if(this.readyState === 4) {
            const result = JSON.parse(this.responseText);
            attempts[task_id] = result.attempts
            successes[task_id] = result.success
          }
        });

        xhr.open("GET", "http://143.198.30.128:5000/get_task_info/" + String(task_id));

        xhr.send();


      var task_attempt = "task"
      var task_success = "task"
      task_attempt = task_attempt.concat(String(task_id))
      task_success = task_success.concat(String(task_id))
      task_attempt = task_attempt.concat("a")
      task_success = task_success.concat("s")
      document.getElementById(task_attempt).innerHTML = attempts[task_id] + " - Attempts" + " <i class=\"blue sync alternate icon\"></i>"
      document.getElementById(task_success).innerHTML = successes[task_id] + " - Success" + " <i class=\"green check icon\"></i>"

      }

      function updateStatisticsInner(){
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;


        xhr.addEventListener("readystatechange", function() {
          if(this.readyState === 4) {
            const result = JSON.parse(this.responseText);
            email = result.total
          }
        });

        xhr.open("GET", "http://143.198.30.128:5000/get_email_amount");
        xhr.send();


      var email_id = "statistics_email"
      document.getElementById(email_id).innerText = String(email)

      }

      function updateBars(){
        for (var i = 0; i < bot_amount; i++) {
            updateBarsInner(bot_ids[i], bot_ips[i]);
        }

      }
      function updateAttempts(){
        for (var i = 0; i < task_amount; i++) {
            updateAttemptsInner(task_ids[i]);
        }

      }
      function updateStatistics(){
        updateStatisticsInner();

      }

      setInterval(updateBars, 3000);
      setInterval(updateAttempts, 3000);
      setInterval(updateStatistics, 15000);
      </script>

<!--HIDDEN DIV AND CLICK HANDLES FOR JS END-->

    </body>

</html>
